// ===============================
// Robustes TimeMoto-Skript (Final V7 - Klick/Timing- & Datum-Fix)
// ===============================

// Zeitbuchungen pro Tag: [Datum, In1, Out1, In2, Out2]
const entries = [
Â  ['2025-10-13', '06:25', '12:09', '12:49', '16:17'],
Â  ['2025-10-14', '06:49', '13:59', '14:29', '18:15'],
Â  ['2025-10-15', '06:37', '13:31', '14:08', '17:27'],
Â  ['2025-10-16', '06:25', '13:33', '14:07', '17:37'],
Â  ['2025-10-17', '06:49', '13:01', '13:34', '17:23'],
Â  ['2025-10-20', '06:37', '13:43', '14:23', '18:11'],
Â  ['2025-10-21', '06:41', '13:33', '14:13', '17:43'],
Â  ['2025-10-22', '06:45', '12:55', '13:30', '17:13'],
Â  ['2025-10-23', '06:49', '12:59', '13:31', '17:43'],
Â  ['2025-10-24', '06:39', '12:21', '12:55', '17:37'],
Â  ['2025-10-27', '06:35', '12:47', '13:23', '17:21'],
Â  ['2025-10-28', '06:39', '13:01', '13:40', '17:07'],
Â  ['2025-10-29', '06:31', '13:01', '13:32', '17:17'],
Â  ['2025-10-30', '06:35', '12:41', '13:17', '16:41'],
Â  ['2025-10-31', '06:33', '12:35', '13:15', '17:17'],
];

// -------------- Hilfsfunktionen --------------

/**
 * Wartet auf ein Element im DOM oder auf eine Bedingungsfunktion (max. timeout ms).
 */
function waitFor(selectorOrFn, timeout = 8000) {
Â  return new Promise((resolve, reject) => {
Â  Â  const start = Date.now();
Â  Â  (function check() {
Â  Â  Â  let conditionMet = false;
Â  Â  Â  let result = null;

Â  Â  Â  if (typeof selectorOrFn === 'string') {
Â  Â  Â  Â  result = document.querySelector(selectorOrFn);
Â  Â  Â  Â  conditionMet = !!result;
Â  Â  Â  } else if (typeof selectorOrFn === 'function') {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  conditionMet = selectorOrFn();
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  conditionMet = false;
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  if (conditionMet) return resolve(result);
Â  Â  Â  if (Date.now() - start > timeout) return reject(new Error(`Bedingung '${typeof selectorOrFn === 'string' ? selectorOrFn : 'Funktion'}' nicht erfÃ¼llt`));
Â  Â  Â  requestAnimationFrame(check);
Â  Â  })();
Â  });
}

/**
 * Simuliert das Tippen von Text in ein Eingabefeld (fÃ¼r robustere Angular/Material-Eingaben).
 */
async function typeText(element, text) {
Â  element.focus();
Â  element.value = ''; // Wichtig: Alten Wert lÃ¶schen
Â  element.dispatchEvent(new Event('input', { bubbles: true }));
Â  element.dispatchEvent(new Event('change', { bubbles: true }));

Â  for (const char of text) {
Â  Â  element.value += char;
Â  Â  element.dispatchEvent(new KeyboardEvent('keydown', { key: char, code: `Key${char.toUpperCase()}` }));
Â  Â  element.dispatchEvent(new Event('input', { bubbles: true }));
Â  Â  element.dispatchEvent(new KeyboardEvent('keyup', { key: char, code: `Key${char.toUpperCase()}` }));
Â  Â  await new Promise(res => setTimeout(res, 10)); // Kurze Pause zwischen Zeichen
Â  }
Â  element.blur();
Â  element.dispatchEvent(new Event('change', { bubbles: true }));
}

/**
 * MatSelect-Option anhand teilweisem Text auswÃ¤hlen
 * Stabilisiert mit Pause nach dem Klick und erhÃ¶htem Timeout.
 */
async function selectOption(selectEl, optionText) {
Â  selectEl.click();
Â  // Feste Pause fÃ¼r das Overlay-Rendern (250ms fÃ¼r mehr StabilitÃ¤t)
Â  await new Promise(res => setTimeout(res, 250));Â 
Â  await waitFor('mat-option', 10000); 
Â Â 
Â  const opts = Array.from(document.querySelectorAll('mat-option'));
Â  const opt = opts.find(o => o.textContent.trim().toLowerCase().includes(optionText.toLowerCase()));
Â Â 
Â  if (!opt) throw new Error(`Option '${optionText}' not found`);
Â  opt.click();
}

/**
 * FÃ¼gt im erweiterten Dialog einen Out-Eintrag hinzu und setzt Zeit & Projekt
 */
async function addOut(timeValue) {
Â  const outButtonSelector = '[data-cy="reporting-timereporting-clockingpair-dialog-add-clock-out-button"]';
Â  const outButtons = document.querySelectorAll(outButtonSelector);
Â  if (outButtons.length === 0) throw new Error("Kein Out-Button gefunden.");
Â Â 
Â  const endInputSelector = 'input[data-cy="reporting-timereporting-clockingpair-dialog-end-time"]';
Â  const initialCount = document.querySelectorAll(endInputSelector).length;

Â  outButtons[outButtons.length - 1].click();

Â  await waitFor(() => document.querySelectorAll(endInputSelector).length > initialCount, 5000);

Â  const endInputs = document.querySelectorAll(endInputSelector);
Â  const endInput = endInputs[endInputs.length - 1];

Â  // Verwende typeText fÃ¼r Zeiteingaben (optional, aber konsistent)
Â  await typeText(endInput, timeValue);

Â  const projectSelectSelector = 'mat-select[data-cy="reporting-timereporting-clockingpair-dialog-end-project-select"]';
Â  const projectSelects = document.querySelectorAll(projectSelectSelector);
Â  await selectOption(projectSelects[projectSelects.length - 1], 'baaboo');
}

/**
 * FÃ¼gt im erweiterten Dialog einen In-Eintrag hinzu und setzt Zeit & Projekt
 */
async function addIn(timeValue) {
Â  const inButtonSelector = '[data-cy="reporting-timereporting-clockingpair-dialog-add-clock-in-button"]';
Â  const inButtons = document.querySelectorAll(inButtonSelector);
Â  if (inButtons.length === 0) throw new Error("Kein In-Button gefunden.");

Â  const startInputSelector = 'input[data-cy="reporting-timereporting-clockingpair-dialog-start-time"]';
Â  const initialCount = document.querySelectorAll(startInputSelector).length;

Â  inButtons[inButtons.length - 1].click();

Â  await waitFor(() => document.querySelectorAll(startInputSelector).length > initialCount, 5000);
Â Â 
Â  const startInputs = document.querySelectorAll(startInputSelector);
Â  const startInput = startInputs[startInputs.length - 1];

Â  // Verwende typeText fÃ¼r Zeiteingaben (optional, aber konsistent)
Â  await typeText(startInput, timeValue);

Â  const projectSelectSelector = 'mat-select[data-cy="reporting-timereporting-clockingpair-dialog-start-project-select"]';
Â  const projectSelects = document.querySelectorAll(projectSelectSelector);
Â  await selectOption(projectSelects[projectSelects.length - 1], 'baaboo');
}

// Hauptfunktion fÃ¼r einen Eintrag
async function addEntry(date, in1, out1, in2, out2) {
Â  console.log(`--- Starte Eintrag fÃ¼r ${date} ---`);
Â Â 
Â  // 1. Dialog Ã¶ffnen
Â  const addBtn = document.querySelector('[data-cy="reporting-timereporting-addclockingaction-button"]')
Â  Â  || Array.from(document.querySelectorAll('a, button')).find(el => el.textContent?.trim() === 'Add Clocking');
Â  if (!addBtn) throw new Error('Add-Clocking-Button nicht gefunden');
Â  addBtn.click();

Â  // 2. Warten, bis Dialog geÃ¶ffnet ist
Â  await waitFor('input[data-cy="reporting-addclockingactiondialog-date-input"]');

Â  // 3. Mitarbeiter setzen (falls nÃ¶tig) - ROBUSTE LOGIK:
Â  const empSelectSelector = 'mat-select[data-cy="reporting-addclockingactiondialog-employee-select"]';
Â  const empSelect = await waitFor(empSelectSelector, 5000);Â 

Â  // Klicke und schlieÃŸe Auswahl, um Angular-Binding zu triggern (falls nÃ¶tig)
Â  empSelect.click();
Â  await new Promise(res => setTimeout(res, 50));Â 
Â  document.body.click();Â 
Â  await new Promise(res => setTimeout(res, 100));Â 

Â  // ZusÃ¤tzliche Pause NACH dem "Wake-up"-Klick, um StabilitÃ¤t zu gewÃ¤hrleisten
Â  await new Promise(res => setTimeout(res, 200)); 

Â  // PrÃ¼fen: Wenn der Name nicht sichtbar ist (entweder leer oder falsch), auswÃ¤hlen.
Â  if (!empSelect.textContent.toLowerCase().includes('alexander')) {
Â  Â  console.log('Mitarbeiter wird manuell gesetzt (oder ist noch leer)...');
Â  Â  await selectOption(empSelect, 'Alexander Bruch');
Â  } else {
Â  Â  console.log('Mitarbeiter ist bereits korrekt voreingestellt.');
Â  }
Â Â 
Â  // 4. Datum setzen - NEUER DATUMS-FIX DURCH typeText!
Â  const dateInput = document.querySelector('input[data-cy="reporting-addclockingactiondialog-date-input"]');
Â  await typeText(dateInput, date);

Â  // 5. Typ "Clock in" setzen
Â  const typeSelect = document.querySelector('mat-select[data-cy="reporting-addclockingactiondialog-status-select"]');
Â  await selectOption(typeSelect, 'Clock in');

Â  // 6. Startzeit (In1) setzen (im Initial-Dialog)
Â  const startInput = document.querySelector('input[data-cy="reporting-addclockingactiondialog-starttime"]');
Â  await typeText(startInput, in1);

Â  // 7. Zu "Advanced clocking settings" wechseln
Â  const advLink = [...document.querySelectorAll('a, button')].find(el => el.textContent?.trim() === 'Advanced clocking settings');
Â  if (!advLink) throw new Error('Advanced clocking settings link not gefunden');
Â  advLink.click();

Â  // 8. Warten, bis erweiterter Dialog geladen ist
Â  const firstStartInputSelector = 'input[data-cy="reporting-timereporting-clockingpair-dialog-start-time"]';
Â  await waitFor(firstStartInputSelector);

Â  // 9. Erste Startzeit & Projekt setzen (BestÃ¤tigung des initialen In1)
Â  const firstStartInput = document.querySelector(firstStartInputSelector);
Â  // Wieder mit typeText, um StabilitÃ¤t zu garantieren
Â  await typeText(firstStartInput, in1);

Â  const firstProjectSelect = document.querySelector('mat-select[data-cy="reporting-timereporting-clockingpair-dialog-start-project-select"]');
Â  await selectOption(firstProjectSelect, 'baaboo');

Â  // 10. Erstes Out
Â  await addOut(out1);

Â  // 11. Zweites In
Â  await addIn(in2);

Â  // 12. Zweites Out
Â  await addOut(out2);

Â  // 13. Speichern
Â  const saveBtn = document.querySelector('button[data-cy="reporting-timereporting-clockingpair-dialog-editPresence-button"]');
Â  if (!saveBtn) throw new Error('Speichern-Button im erweiterten Dialog nicht gefunden');
Â  saveBtn.click();

Â  // 14. Warte auf Speicherung
Â  await new Promise(res => setTimeout(res, 1200));Â 
}

// Sequentially add all entries
async function run() {
Â  for (const [date, in1, out1, in2, out2] of entries) {
Â  Â  console.log(`FÃ¼ge ${date} ein...`);
Â  Â  try {
Â  Â  Â  await addEntry(date, in1, out1, in2, out2);
Â  Â  Â  console.log(`Eintrag fÃ¼r ${date} erfolgreich.`);
Â  Â  } catch (error) {
Â  Â  Â  console.error(`ðŸš¨ Fehler beim EinfÃ¼gen von ${date}:`, error.message);
Â  Â  Â  break; // Stoppe bei Fehler
Â  Â  }
Â  }
Â  console.log('âœ… Alle verbleibenden EintrÃ¤ge eingetragen (oder nach Fehler gestoppt).');
}

run().catch(err => console.error('ðŸ”´ Kritischer Skriptfehler (vor Start oder im Run-Loop):', err));
